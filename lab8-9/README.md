# How to
* Насамперід потрібно створити `DataBricks`. Для цього в пошуку на ажур порталі вбиваємо `Azure Databricks`, переходимо, натискаємо на `Create`. Заповнюємо поля, в полі `Pricing Tier` обираємо `Trial`.
* Після створення переходимо на сторінку новостворенного ресурсу, та натискаємо на синю кнопку `Launch Workspace`
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2019.08.00.png)
* Це перекине нас на основну сторінку датабріксу. В боковому меню обираємо `Clusters`, потім натискаємо на `Create Cluster`. Даємо кластеру назву. В полі `Cluster Mode` обираємо тип кластеру ( я обрав тип `Single Node` через те що інші типи потребують більшу кількість ядер, яку мій аккаунт через ліміт квоти дати не міг, можливо в вас буде по іншому).
* В полі `Databricks Runtime Version` обираємо версію 6.4. Інші поля не рухаємо, натискаємо на `Create Cluster`.
* Кластер буде створюватись орієнтовно 5-10 хв. Тому перейдемо до наступних кроків.
* Наступним кроком буде створення `Azure Storage Account`. Для цього в полі пошуку ажур порталу `Azure Storage Account`. Переходимо по ньому.
* Натискаємо на `Create`. Заповнюємо поля. В вкладці `Advanced` опускаємось до `Data Lake Storage Gen2` та клікаємо на `Enabled` навпроти опції `Hierarchical namespace`. Після цього підтверджуємо створення.
* Переходимо в створенний сторедж аккаунт, в боковому меню опускаємось до `Data Lake Storage` > `Containers`. Натискаємо на кнопку створення контейнера, даємо йому назву, а в `Public Access Level` обираємо `Container`. 
* Наступним кроком буде реєстрація аппки. Для цього в полі пошуку ажур порталу вбиваємо `Azure Active Directory`. Переходимо, в боковому меню спускаємось до `App registration` > кнопка `New Registation` > даємо назву. Після цього нас перекине на новостворенний ресурс. В боковому меню спускаємось до `Certificates & Secrets` > в області `Client Secrets` > `New client secret` > даємо йому назву. Після створення сікрета, сторінку не варто перезагружати, або закривати, так як значення нам пригодиться потім.
* Для наступного кроку необхідна програма `Microsoft Azure Storage Explorer` https://azure.microsoft.com/en-us/features/storage-explorer/
* Після завантаження та установки програми, відкриваємо її, та логінимся в свій аккаунт.
* Після цього ми побачимо ієрархію сторедж аккаунтів та інших ресурсів, шукаємо наш сторедж, розгортаємо його, обираєм наш контейнер, клікаєм на нього, натискаємо на кнопку `New Folder` 
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2019.31.29.png)
* В боковому меню експлорера натискаємо правою кнопкою мишки на по нашому контейнеру та обираємо `Manage Access Control Lists`, натискаємо на `Add`, а в полі пошуку вбиваємо назву апки, яку ми зареєстрували в одному з попередніх кроків.
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2019.55.32.png)
* Після того, як ми додали апку, потрібно їй надати права.
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2019.58.32.png)
* Можливо на наступних кроках можуть виникнути проблеми з правами, тому я б радив зробити попередні два кроки і для папки, яку ми недавно створили.
* За цей час кластер DataBricks вже б мав бути створенний. 
* Заходимо в наш кластер, клікаємо на `Libraries` > `Install New` > `Maven` > в `Coordinates` вбиваємо дане значення `com.microsoft.azure:azure-eventhubs-spark_2.11:2.3.18` > `Install`.
* Поки ліба встановлюється, повертаємось на головну сторінку `DataBricks` натискаємо на `New notebook`. Даємо назву, обираємо `Python` та обираємо кластер, який ми раніше створили.
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2020.06.22.png)
* В новостворенний журна копіюємо код з файлу `mount.py`, та замінємо деякі дані, які там вказані, а саме:
 1. значення з `"fs.azure.account.oauth2.client.id"` на `application (client) id` з апки, яку ми раніше зареєстрували в `Active Directory`
 2. значення з `"fs.azure.account.oauth2.client.secret"` на значення з сікрету, який ми також створили раніше ( з вкладки, яку я казав не закривати).
 3. значення з `"fs.azure.account.oauth2.client.endpoint"`, в посиланні є `<tenant-id>`, яке ми міняємо на Tenant ID з основної сторінки зареєстрованої апки
 ![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2020.16.11.png)
 4. `source` - замінити значення `<storage_container>` та `<storage_accoun_name>` на відповідні до попередньо створенних
 5. `mount_point` - `<directory_name>` замінити на назву папки, яку ми створили всередині контейнера.
 6. в останньому радку, зробити теж саме, що й кроці 5.
* Після того як все було замінено, запускаємо данний шмат коду.
* Як результат виконання, ви маєте побачити щось схоже
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2020.27.26.png)
* Це означає, що кластер успішно замаунтив файлову систему з контейнера.
* Наступним кроком потрібно створити ще один notebook, але на цей раз обираємо `Scala`.
* Копіпастимо код з файлу `eventHub.scala`
* В данному файлі також необхідно дещо замінити: `appID`, `password`, `tenantID` на `application (client) id`,  `password` -  значення з сікрета, `tenantID`, які можна скопіювати з попереднього файлу). `fileSystemName` на назву контейнера, а `storageAccountName` на назву сторедж аккаунта. `connectionString` - конекшин стрінга до сервісу івент хабу ( не з інстансу) з 5 лабораторної. `setEventHubName` - на ім’я інстансу івентхаб.
* В функції `filtered` потрібно змінити назви json полів на відповідні до вашого датасету. 
* В двох останніх рядках, замість `<path>` потрібно підставити значення, яке ми отримали як вивід, коли запускали код, який маунтив файлову системи до кластеру. Або вказати вручну в форматі `/mnt/<container_name>/<directory_name>`
* Після цього нарешті запускамо скалівський код, одночасно з цим потрібно запустити вашу 5 лабораторну, щоб записати інформацію в `event hub`. Датабрікс запустить "джобу", яка буде парсити значення з івент хабу та записувати їх в файли. В залежності від кількості інформації виконання данної джоби, може зайняти різну кількість часу. Проте через секунд 30 в папці контейнера мають появлятись нові файли, в які будуть записані дані.
* Відкриваємо якийсь файл, та маємо побачити схожий вивід
![alt text](http://img.empeek.net/Screenshot%202021-01-10%20at%2021.18.25.png)







